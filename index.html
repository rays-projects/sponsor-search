<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Áï™ÁµÑ„Çπ„Éù„É≥„Çµ„ÉºÊ§úÁ¥¢</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f4f4f4;
      margin: 0;
      padding: 16px;
      transition: background .2s, color .2s;
    }

    body.dark {
      background: #0f172a;
      color: #e5e7eb;
    }

    h1 {
      text-align: center;
    }

    .search-box {
      max-width: 800px;
      margin: 0 auto 12px;
      display: flex;
      gap: 8px;
    }

    input, select {
      flex: 1;
      padding: 8px;
      font-size: 14px;
    }

    .count {
      max-width: 800px;
      margin: 0 auto 8px;
      font-size: 14px;
      color: #555;
    }

    body.dark .count {
      color: #cbd5f5;
    }

    .tags {
      max-width: 800px;
      margin: 0 auto 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .tag {
      padding: 4px 10px;
      border-radius: 999px;
      background: #e0e7ff;
      color: #1e3a8a;
      font-size: 13px;
      cursor: pointer;
      user-select: none;
    }

    .tag.active {
      background: #2563eb;
      color: #fff;
    }

    body.dark .tag {
      background: #334155;
      color: #e5e7eb;
    }

    body.dark .tag.active {
      background: #3b82f6;
    }

    ul {
      max-width: 800px;
      margin: 0 auto;
      padding: 0;
      list-style: none;
    }

    li {
      background: #fff;
      margin-bottom: 12px;
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,.08);
      cursor: pointer;
      transition: background .2s;
    }

    li:hover {
      background: #f0f7ff;
    }

    body.dark li {
      background: #1e293b;
      box-shadow: none;
    }

    body.dark li:hover {
      background: #334155;
    }

    .program {
      font-size: 18px;
      font-weight: bold;
    }

    .meta {
      font-size: 14px;
      color: #555;
      margin-top: 4px;
    }

    body.dark .meta {
      color: #cbd5f5;
    }

    .sponsors {
      margin-top: 6px;
      font-size: 14px;
    }

    .theme-btn {
      position: fixed;
      top: 16px;
      right: 16px;
      padding: 6px 10px;
      font-size: 13px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: #fff;
      cursor: pointer;
    }

    body.dark .theme-btn {
      background: #1e293b;
      color: #e5e7eb;
      border-color: #334155;
    }
  </style>
</head>
<body>

<button id="themeToggle" class="theme-btn">üåô „ÉÄ„Éº„ÇØ„É¢„Éº„Éâ</button>

<h1>Áï™ÁµÑ„Çπ„Éù„É≥„Çµ„ÉºÊ§úÁ¥¢</h1>

<div class="search-box">
  <input type="text" id="keyword" placeholder="Áï™ÁµÑÂêç„Éª„Çπ„Éù„É≥„Çµ„ÉºÂêç„ÅßÊ§úÁ¥¢">
  <select id="dayFilter">
    <option value="">„Åô„Åπ„Å¶„ÅÆÊõúÊó•</option>
    <option value="Êúà">Êúà</option>
    <option value="ÁÅ´">ÁÅ´</option>
    <option value="Ê∞¥">Ê∞¥</option>
    <option value="Êú®">Êú®</option>
    <option value="Èáë">Èáë</option>
    <option value="Âúü">Âúü</option>
    <option value="Êó•">Êó•</option>
  </select>
</div>

<div class="tags" id="sponsorTags"></div>

<div class="count" id="count"></div>
<ul id="results"></ul>

<script>
  /* üåô „ÉÄ„Éº„ÇØ„É¢„Éº„Éâ */
  const toggleBtn = document.getElementById("themeToggle");

  if (localStorage.getItem("theme") === "dark") {
    document.body.classList.add("dark");
    toggleBtn.textContent = "‚òÄÔ∏è „É©„Ç§„Éà„É¢„Éº„Éâ";
  }

  toggleBtn.onclick = () => {
    document.body.classList.toggle("dark");
    const dark = document.body.classList.contains("dark");
    localStorage.setItem("theme", dark ? "dark" : "light");
    toggleBtn.textContent = dark ? "‚òÄÔ∏è „É©„Ç§„Éà„É¢„Éº„Éâ" : "üåô „ÉÄ„Éº„ÇØ„É¢„Éº„Éâ";
  };

  /* „Éá„Éº„Çø */
  let programs = [];
  let activeSponsors = new Set();

  const keywordInput = document.getElementById("keyword");
  const daySelect = document.getElementById("dayFilter");

  function updateURL() {
    const params = new URLSearchParams();

    if (keywordInput.value) params.set("keyword", keywordInput.value);
    if (daySelect.value) params.set("day", daySelect.value);
    if (activeSponsors.size > 0) {
      params.set("sponsor", [...activeSponsors].join(","));
    }

    history.replaceState(null, "", "?" + params.toString());
  }

  function restoreFromURL() {
    const params = new URLSearchParams(location.search);

    if (params.get("keyword")) {
      keywordInput.value = params.get("keyword");
    }

    if (params.get("day")) {
      daySelect.value = params.get("day");
    }

    if (params.get("sponsor")) {
      params.get("sponsor").split(",").forEach(s => activeSponsors.add(s));
    }
  }

  async function loadData() {
    const res = await fetch("./data/sponsors.json");
    programs = await res.json();
    restoreFromURL();
    renderTags();
    render();
  }

  function getSponsors(p) {
    return [p.sponsor1, p.sponsor2, p.sponsor3].filter(s => s && s !== "-");
  }

  function renderTags() {
    const allSponsors = [...new Set(programs.flatMap(getSponsors))];
    const tagBox = document.getElementById("sponsorTags");

    tagBox.innerHTML = allSponsors.map(s => `
      <div class="tag ${activeSponsors.has(s) ? "active" : ""}" data-name="${s}">
        ${s}
      </div>
    `).join("");

    document.querySelectorAll(".tag").forEach(tag => {
      tag.onclick = () => {
        const name = tag.dataset.name;
        activeSponsors.has(name) ? activeSponsors.delete(name) : activeSponsors.add(name);
        updateURL();
        renderTags();
        render();
      };
    });
  }

  function render() {
    const keyword = keywordInput.value.toLowerCase();
    const day = daySelect.value;

    const filtered = programs.filter(p => {
      const sponsors = getSponsors(p);

      const textMatch =
        p.program.toLowerCase().includes(keyword) ||
        sponsors.some(s => s.toLowerCase().includes(keyword));

      const dayMatch = !day || p.day.includes(day);
      const sponsorMatch =
        activeSponsors.size === 0 ||
        sponsors.some(s => activeSponsors.has(s));

      return textMatch && dayMatch && sponsorMatch;
    });

    document.getElementById("count").textContent =
      `${filtered.length} ‰ª∂„ÅÆÁï™ÁµÑ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åó„Åü`;

    document.getElementById("results").innerHTML = filtered.map(p => `
      <li onclick="location.href='program.html?id=${p.id}'">
        <div class="program">${p.program}</div>
        <div class="meta">
          ÊîæÈÄÅÂ±ÄÔºö${p.station} Ôºè ${p.day} ${p.time} Ôºè ${p.genre}
        </div>
        <div class="sponsors">
          „Çπ„Éù„É≥„Çµ„ÉºÔºö${getSponsors(p).join(" / ") || "‰∏çÊòé"}
        </div>
      </li>
    `).join("");
  }

  keywordInput.addEventListener("input", () => {
    updateURL();
    render();
  });

  daySelect.addEventListener("change", () => {
    updateURL();
    render();
  });

  loadData();
</script>

</body>
</html>